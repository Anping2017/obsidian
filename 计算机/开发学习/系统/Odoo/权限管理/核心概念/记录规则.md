ï¼ˆRecord Rulesï¼‰

## 1) æœºåˆ¶ä¸æ¦‚å¿µï¼ˆææ¸…â€œè°å…ˆè°åâ€ï¼‰

- **è§¦å‘é¡ºåº**ï¼šå…ˆæ£€æŸ¥ **ACL**ï¼ˆæ¨¡å‹çš„è¯»/å†™/å»º/åˆ æƒé™ï¼‰ï¼Œé€šè¿‡åæ‰ä¼šåº”ç”¨**è®°å½•è§„åˆ™**åšâ€œæ•°æ®è¡Œçº§è¿‡æ»¤â€ã€‚[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)
    
- **æ— è§„åˆ™=å…è®¸**ï¼šè‹¥ ACL å…è®¸ã€ä¸”è¯¥æ¨¡å‹/æ“ä½œæ²¡æœ‰ä»»ä½•é€‚ç”¨çš„è®°å½•è§„åˆ™ï¼Œåˆ™é»˜è®¤å…è®¸è®¿é—®ã€‚[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)
    
- **ä¸¤ç±»è§„åˆ™å¦‚ä½•ç»„åˆ**ï¼š
    
    - **å…¨å±€è§„åˆ™ï¼ˆæ— åˆ†ç»„ï¼‰**ï¼šç›¸äº’ **ç›¸äº¤ï¼ˆANDï¼‰**ï¼Œå åŠ è¶Šå¤šè¶Šä¸¥æ ¼ï¼›
        
    - **åˆ†ç»„è§„åˆ™ï¼ˆç»‘å®šåˆ°æŸäº› groupsï¼‰**ï¼šå½¼æ­¤ **å¹¶é›†ï¼ˆORï¼‰**ï¼Œèƒ½æ”¾å®½è®¿é—®ï¼Œä½†**ä¸ä¼šçªç ´å…¨å±€è§„åˆ™**çš„è¾¹ç•Œï¼›
        
    - **å…¨å±€ âˆ© åˆ†ç»„**ï¼šå…ˆç”¨å…¨å±€æ”¶ç´§ï¼Œå†ç”±åˆ†ç»„åœ¨è¿™ä¸ªè¾¹ç•Œå†…æ”¾å®½ã€‚[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)
        

> âš ï¸ å«ä¹‰ï¼šç¬¬ä¸€ä¸ªåˆ†ç»„è§„åˆ™é€šå¸¸ä¼šâ€œå˜ä¸¥â€ï¼ˆå› ä¸ºä¸å…¨å±€ç›¸äº¤ï¼‰ï¼Œä¹‹åè¿½åŠ çš„åˆ†ç»„è§„åˆ™æ‰å¯èƒ½â€œæ”¾å®½â€ã€‚[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)

## ğŸ”‘ è®°å½•è§„åˆ™çš„ç»„åˆé€»è¾‘

### a. å…¨å±€è§„åˆ™ï¼ˆGlobal Ruleï¼‰

- å®šä¹‰æ—¶ **ä¸ç»‘å®šä»»ä½•ç»„ï¼ˆgroups ä¸ºç©ºï¼‰**ã€‚
    
- é€‚ç”¨äºç³»ç»Ÿä¸­æ‰€æœ‰ç”¨æˆ·ï¼ˆåŒ…æ‹¬è¶…çº§ç”¨æˆ·é™¤å¤–ï¼‰ã€‚
    
- **ç»„åˆæ–¹å¼**ï¼šå¤šä¸ªå…¨å±€è§„åˆ™ä¹‹é—´æ˜¯ **ç›¸äº¤ï¼ˆANDï¼‰**ã€‚
    
    - æ¯æ¡å…¨å±€è§„åˆ™éƒ½ä¼šç”Ÿæ•ˆï¼Œè¿‡æ»¤æ¡ä»¶è¶Šæ¥è¶Šä¸¥æ ¼ã€‚
        

ğŸ‘‰ ä¸¾ä¾‹ï¼š

- å…¨å±€è§„åˆ™ Aï¼šåªèƒ½çœ‹è‡ªå·±åˆ›å»ºçš„è®°å½• â†’ `[('create_uid', '=', user.id)]`
    
- å…¨å±€è§„åˆ™ Bï¼šåªèƒ½çœ‹å±äºå½“å‰å…¬å¸æ•°æ® â†’ `[('company_id', 'in', company_ids)]`
    
- æœ€ç»ˆç»“æœ = A âˆ© B â†’ ç”¨æˆ·åªèƒ½çœ‹â€œè‡ªå·±åˆ›å»º + å±äºè‡ªå·±å…¬å¸â€çš„è®°å½•ã€‚
    

---

### b. åˆ†ç»„è§„åˆ™ï¼ˆGroup Ruleï¼‰

- å®šä¹‰æ—¶ **ç»‘å®šåˆ°ä¸€ä¸ªæˆ–å¤šä¸ªç”¨æˆ·ç»„**ã€‚
    
- åªæœ‰è¯¥ç»„å†…çš„ç”¨æˆ·æ‰å—è§„åˆ™é™åˆ¶ã€‚
    
- **ç»„åˆæ–¹å¼**ï¼šåŒä¸€æ¨¡å‹ä¸‹çš„å¤šæ¡åˆ†ç»„è§„åˆ™æ˜¯ **å¹¶é›†ï¼ˆORï¼‰**ã€‚
    
    - æ»¡è¶³å…¶ä¸­ä»»æ„ä¸€ä¸ª domain æ¡ä»¶ï¼Œå°±èƒ½çœ‹åˆ°è®°å½•ã€‚
        

ğŸ‘‰ ä¸¾ä¾‹ï¼š

- åˆ†ç»„è§„åˆ™ Aï¼šé”€å”®å‘˜ â†’ `[('user_id', '=', user.id)]`ï¼ˆåªèƒ½çœ‹è‡ªå·±å•ï¼‰
    
- åˆ†ç»„è§„åˆ™ Bï¼šé”€å”®ç»ç† â†’ `[(1, '=', 1)]`ï¼ˆèƒ½çœ‹å…¨éƒ¨ï¼‰
    
- åŒæ—¶åœ¨â€œé”€å”®ç»ç†ç»„â€çš„ç”¨æˆ·ï¼Œæœ€ç»ˆèƒ½çœ‹ = è‡ªå·±å• âˆª å…¨éƒ¨ = å…¨éƒ¨æ•°æ®ã€‚
    

---

### c. å…¨å±€ âˆ© åˆ†ç»„

- æœ€ç»ˆç»“æœï¼š**å…¨å±€è§„åˆ™å…ˆæ”¶ç´§ï¼Œåˆ†ç»„è§„åˆ™åœ¨è¿™ä¸ªè¾¹ç•Œé‡Œæ”¾å®½**ã€‚
    
- æ¢å¥è¯è¯´ï¼šåˆ†ç»„è§„åˆ™ **ä¸èƒ½çªç ´å…¨å±€è§„åˆ™çš„é™åˆ¶**ã€‚
    

ğŸ‘‰ ä¸¾ä¾‹ï¼š

- å…¨å±€è§„åˆ™ï¼šæ‰€æœ‰é”€å”®è®¢å•å¿…é¡»å±äºå½“å‰å…¬å¸ â†’ `[('company_id', 'in', company_ids)]`
    
- åˆ†ç»„è§„åˆ™ï¼š
    
    - é”€å”®å‘˜ï¼š`[('user_id', '=', user.id)]`
        
    - é”€å”®ç»ç†ï¼š`[(1, '=', 1)]`ï¼ˆæ‰€æœ‰è®¢å•ï¼‰
        
- æœ€ç»ˆç»“æœï¼š
    
    - é”€å”®å‘˜ â†’ â€œè‡ªå·± + å½“å‰å…¬å¸â€è®¢å•ã€‚
        
    - é”€å”®ç»ç† â†’ â€œæ‰€æœ‰è®¢å• + å½“å‰å…¬å¸â€è®¢å•ï¼ˆä¸èƒ½çœ‹åˆ°åˆ«çš„å…¬å¸è®¢å•ï¼‰ã€‚


---

## 2) å®šä¹‰ä½ç½®ä¸å…³é”®å­—æ®µï¼ˆir.ruleï¼‰

- **æ¨¡å‹**ï¼š`ir.rule`
    
- å…³é”®å­—æ®µï¼š
    
    - `model_id`ï¼ˆä½œç”¨å¯¹è±¡ï¼‰
        
    - `groups`ï¼ˆä¸å¡«=å…¨å±€è§„åˆ™ï¼‰
        
    - `domain_force`ï¼ˆæ ¸å¿ƒï¼šåŸŸè¡¨è¾¾å¼ï¼‰
        
    - `perm_read/perm_write/perm_create/perm_unlink`ï¼ˆè¯¥è§„åˆ™ä½œç”¨åˆ°å“ªäº›æ“ä½œï¼‰
        
- **åŸŸä¸­å¯ç”¨å˜é‡**ï¼š`user`ã€`company_id`ã€`company_ids`ã€`time` ç­‰ã€‚[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)
    

---

## 3) åŸŸï¼ˆdomainï¼‰å†™æ³•è¦ç‚¹

- å…¸å‹ **True** åŸŸï¼š`[(1, '=', 1)]`ï¼ˆç­‰ä»·â€œä¸è¿‡æ»¤â€ï¼‰ã€‚
    
- å…¸å‹ **False** åŸŸï¼š`[(1, '=', 0)]`ï¼ˆç­‰ä»·â€œå…¨éƒ¨æ‹’ç»â€â€”â€”æ…ç”¨ï¼Œé€šå¸¸ä½œä¸º**å…¨å±€**è§„åˆ™æ—¶ä¼šç›´æ¥å°æ­»ï¼‰ã€‚
    
- **company å…±äº«**å¸¸ç”¨å†™æ³•ï¼š`['|', ('company_id', '=', False), ('company_id', 'in', company_ids)]`ï¼ˆå…è®¸â€œæ— å…¬å¸è®°å½•â€+â€œåœ¨å¯è®¿é—®å…¬å¸å†…çš„è®°å½•â€ï¼‰ã€‚[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)
    

---

## 4) å¸¸è§åœºæ™¯ä¸å¯å¤åˆ¶ç¤ºä¾‹

### A. åªçœ‹è‡ªå·±åˆ›å»º/è´Ÿè´£çš„è®°å½•

**æ€è·¯**ï¼šç»‘å®šåˆ°â€œå‘˜å·¥/ä¸šåŠ¡å‘˜ç»„â€çš„**åˆ†ç»„è§„åˆ™**ï¼ŒæŒ‰è´Ÿè´£äººæˆ–åˆ›å»ºè€…è¿‡æ»¤ã€‚

```
<record id="rule_so_salesman_own" model="ir.rule">
  <field name="name">Sales Orders - Own Only</field>
  <field name="model_id" ref="sale.model_sale_order"/>
  <field name="groups" eval="[(6,0,[ref('sales_team.group_sale_salesman')])]"/>
  <!-- é€‰ä½ ç”¨çš„å­—æ®µï¼šuser_id / create_uid -->
  <field name="domain_force">[('user_id','=', user.id)]</field>
  <field name="perm_read" eval="True"/>
  <field name="perm_write" eval="True"/>
  <field name="perm_create" eval="True"/>
  <field name="perm_unlink" eval="False"/>
</record>
```


> æ³¨ï¼šä¹Ÿå¯ç”¨ `('create_uid','=', user.id)`ï¼›æ¨èä¼˜å…ˆç”¨ä¸šåŠ¡â€œè´Ÿè´£äººå­—æ®µâ€ï¼ˆå¦‚ `user_id`ï¼‰ã€‚[cybrosys.com+1](https://www.cybrosys.com/blog/how-to-create-record-rules-in-odoo-17?utm_source=chatgpt.com)

---

### B. ä»…è®¿é—®å½“å‰å…¬å¸æ•°æ®ï¼ˆå¤šå…¬å¸éš”ç¦»ï¼‰

**æ€è·¯**ï¼šåš**å…¨å±€è§„åˆ™**ï¼ˆä¸ç»‘ç»„ï¼‰ï¼Œæ‰€æœ‰äººéƒ½å—é™ï¼›å…è®¸â€œæ— å…¬å¸è®°å½•â€ã€‚

```
<record id="rule_global_company_isolation" model="ir.rule">
  <field name="name">Global - Company Isolation</field>
  <field name="model_id" ref="sale.model_sale_order"/>
  <!-- ä¸è®¾ç½® groups = å…¨å±€è§„åˆ™ -->
  <field name="domain_force">
    ['|', ('company_id','=', False), ('company_id','in', company_ids)]
  </field>
  <field name="perm_read" eval="True"/>
  <field name="perm_write" eval="True"/>
  <field name="perm_create" eval="True"/>
  <field name="perm_unlink" eval="True"/>
</record>

```

> å…¨å±€è§„åˆ™å½¼æ­¤ **AND**ï¼›ä¸åˆ†ç»„è§„åˆ™ **ç›¸äº¤**ã€‚è¿™æ˜¯å¤šå…¬å¸éš”ç¦»çš„æ ‡å‡†å†™æ³•ã€‚[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)

---

### C. éƒ¨é—¨ç»ç†å¯çœ‹æœ¬éƒ¨é—¨ï¼ˆå«ä¸‹å±ï¼‰æ•°æ®

**å‰æ**ï¼šæœ‰ HR ç»„ç»‡ç»“æ„ï¼ˆ`hr.employee.department_id`ï¼‰ï¼Œè®°å½•ä¸Šèƒ½å…³è”è´Ÿè´£äººæˆ–å‘˜å·¥ã€‚

```
<record id="rule_mgr_department_scope" model="ir.rule">
  <field name="name">Manager - Department & Sub</field>
  <field name="model_id" ref="sale.model_sale_order"/>
  <field name="groups" eval="[(6,0,[ref('sales_team.group_sale_manager')])]"/>
  <field name="domain_force">
    ['|',
      ('user_id','=', user.id),
      ('user_id.employee_id.department_id', 'child_of', user.employee_id.department_id.id)
    ]
  </field>
  <field name="perm_read" eval="True"/>
  <field name="perm_write" eval="True"/>
</record>

```

> `child_of` ä¼šåŒ…å«å­éƒ¨é—¨ã€‚è‹¥æ²¡è£… HRï¼Œå¯æ”¹ä¸ºä½ è‡ªå»ºçš„â€œéƒ¨é—¨/å›¢é˜Ÿâ€å­—æ®µé“¾è·¯ã€‚[Stack Overflow](https://stackoverflow.com/questions/75087744/how-to-manage-implicit-groups-in-record-rules?utm_source=chatgpt.com)

---

### D. åªå…è®¸â€œè‰ç¨¿â€å¯åˆ é™¤/ç¼–è¾‘ï¼ˆæ¡ä»¶æ“ä½œæƒé™ï¼‰

**åšæ³•**ï¼šé’ˆå¯¹ **write/unlink** å‹¾é€‰ï¼Œä»…å½“æ»¡è¶³åŸŸæ‰å…è®¸å¯¹åº”æ“ä½œï¼›ä¸æ»¡è¶³åˆ™ç­‰åŒäº**æ— åŒ¹é…è§„åˆ™â†’æ‹’ç»**ã€‚

```
<record id="rule_edit_draft_only" model="ir.rule">
  <field name="name">Edit/Unlink Draft Only</field>
  <field name="model_id" ref="sale.model_sale_order"/>
  <!-- å¯è®¾ä¸ºå…¨å±€æˆ–åˆ†ç»„ -->
  <field name="domain_force">[('state','=','draft')]</field>
  <field name="perm_read" eval="False"/>
  <field name="perm_write" eval="True"/>
  <field name="perm_unlink" eval="True"/>
  <field name="perm_create" eval="False"/>
</record>

```

> è§„åˆ™ä¸Šçš„ `perm_*` åœ¨è®°å½•è§„åˆ™é‡Œè¡¨ç¤ºâ€œè§„åˆ™é€‚ç”¨äºå“ªäº›æ“ä½œâ€ï¼Œä¸æ˜¯æˆäºˆåŠ¨ä½œæœ¬èº«ã€‚[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)

---

## 5) è°ƒè¯•ä¸æ’é”™ï¼ˆæœ€å®ç”¨æ¸…å•ï¼‰

1. **å¼€å‘è€…æ¨¡å¼** â†’ è®¾ç½® â–¸ æŠ€æœ¯ â–¸ å®‰å…¨æ€§ â–¸ è®°å½•è§„åˆ™/è®¿é—®æƒé™ï¼Œæ ¸å¯¹**è°ç”Ÿæ•ˆ**ã€**å¯¹å“ªäº›æ“ä½œç”Ÿæ•ˆ**ã€‚[Bassam Infotech+1](https://bassaminfotech.com/creating-a-record-rule-in-odoo/?utm_source=chatgpt.com)
    
2. **ç”¨æˆ·è§†è§’å¤ç°**ï¼š
    
    - Shell/ä»£ç é‡Œç”¨ `with_user(u)` å¯¹æ¯” `sudo()` çš„æœç´¢ç»“æœï¼š
        
```
env['sale.order'].with_user(u).search_count([])
env['sale.order'].sudo().search_count([])

```


`check_access_rights('read', raise_exception=False)` ä¸ `check_access_rule('read')` è¾…åŠ©å®šä½ã€‚



3. **é€æ­¥æ’é™¤**ï¼šå…ˆåœç”¨å¯ç–‘è§„åˆ™ï¼ˆå–æ¶ˆå‹¾é€‰â€œå¯ç”¨/Activeâ€ï¼‰ï¼Œå†è§‚å¯Ÿç»“æœå˜åŒ–ã€‚[useopenerp.com](https://useopenerp.com/v8/model/ir-rule?utm_source=chatgpt.com)
    
4. **ç»„åˆå…³ç³»å¿ƒæ³•**ï¼š
    
    - å…¨å±€è§„åˆ™ **AND**ï¼Œæ˜“â€œäº’ä¸ç›¸äº¤â†’å…¨è¢«æŒ¡â€ï¼›
        
    - åˆ†ç»„è§„åˆ™ **OR**ï¼Œè¶ŠåŠ è¶Šæ”¾å®½ï¼Œä½†æ”¾ä¸å‡ºå…¨å±€å›´æ ï¼›
        
    - å…ˆæœ‰ ACLï¼Œå†è°ˆè®°å½•è§„åˆ™ã€‚[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)
        
5. **å¤šå…¬å¸é™·é˜±**ï¼šåˆ«å¿˜äº†ç»Ÿä¸€åŠ  `('company_id','in', company_ids)`ï¼ˆæˆ–å« `False` çš„å¹¶è”ï¼‰ï¼Œé¿å…è·¨å…¬å¸è¯¯è§æˆ–è¯¯æ‹’ã€‚[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)
    
6. **å†™/åˆ è¢«æ‹¦**ï¼šè‹¥è¯»å¾—åˆ°ä½†å†™/åˆ æŠ¥é”™ï¼Œæ£€æŸ¥ï¼š
    
    - ACL æ˜¯å¦ç»™äº† write/unlinkï¼›
        
    - è®°å½•è§„åˆ™é‡Œ `perm_write/perm_unlink` æ˜¯å¦å‹¾äº†ï¼Œä¸”åŸŸæ˜¯å¦åŒ¹é…å½“å‰è®°å½•ã€‚[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)
        

---

## 6) å®‰å…¨ä¸æœ€ä½³å®è·µ

- **å…ˆ ACL åè§„åˆ™**ï¼šèƒ½ç”¨ ACL æ§ä½â€œèƒ½å¦å†™/åˆ â€ï¼Œå°±å…ˆç”¨ ACLï¼›æ¡ä»¶åŒ–å†ç”¨è§„åˆ™ç»†åŒ–ï¼ˆå¦‚ä»… draft å¯åˆ ï¼‰ã€‚[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)
    
- **å…¨å±€è§„åˆ™è¶Šå°‘è¶Šå¥½**ï¼šé›†ä¸­å¤„ç†â€œå…¬å¸éš”ç¦»/å½’æ¡£è¿‡æ»¤â€ç­‰å…±æ€§ï¼Œé¿å…å¤šä¸ªå…¨å±€åŸŸäº’ç›¸â€œæ‰“æ¶â€ã€‚[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)
    
- **é¿å…æ»¥ç”¨ `sudo()`**ï¼šå¤–éƒ¨æ¥å£/æŒ‰é’®è‹¥ç”¨ `sudo()` å†™æ•°æ®ï¼Œå¯èƒ½ç»•è¿‡è®°å½•è§„åˆ™ï¼›è°¨æ…ä½¿ç”¨ã€‚[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)
    
- **äº’æ–¥ç»„è®¾è®¡**ï¼šå±‚çº§ç»„ç»§æ‰¿å¸¸ä¼šæŠŠâ€œå¯è§æ€§è§„åˆ™â€ä¸€å¹¶ç»§æ‰¿åˆ°ç»ç†ç»„ï¼›å¿…è¦æ—¶ç»™ç»ç†ç»„**å•ç‹¬è¦†ç›–**ä¸€æ¡æ”¾å®½è§„åˆ™ã€‚[Stack Overflow](https://stackoverflow.com/questions/75087744/how-to-manage-implicit-groups-in-record-rules?utm_source=chatgpt.com)
# 🌐 Odoo 数据批量导入与导出

---

## 1. 核心概念

- **批量操作**：一次性处理多条记录，避免循环单条操作，提高性能
    
- **可用接口**：
    
    1. XML-RPC
        
    2. JSON-RPC
        
    3. 自定义 RESTful API
        
- **常用场景**：
    
    - 导入客户、产品、订单
        
    - 导出销售数据、库存数据
        
    - 第三方系统数据同步
        

---

## 2. 批量导入数据

### 2.1 XML-RPC 示例

```
import xmlrpc.client

url = 'http://localhost:8069'
db = 'odoo_db'
username = 'admin'
password = 'admin'

common = xmlrpc.client.ServerProxy(f'{url}/xmlrpc/2/common')
uid = common.authenticate(db, username, password, {})

models = xmlrpc.client.ServerProxy(f'{url}/xmlrpc/2/object')

# 批量创建客户
customers = [
    {'name': 'Alice', 'email': 'alice@example.com'},
    {'name': 'Bob', 'email': 'bob@example.com'},
    {'name': 'Charlie', 'email': 'charlie@example.com'},
]

customer_ids = models.execute_kw(db, uid, password,
    'res.partner', 'create', customers)  # 注意：部分版本可能需要循环 create

```

> ⚠️ 小提示：部分 Odoo 版本 `create` 只能单条操作，可通过循环或自定义方法批量创建。

---

### 2.2 JSON-RPC 示例

```
import requests
import json

url = 'http://localhost:8069/jsonrpc'
db = 'odoo_db'
username = 'admin'
password = 'admin'

# 登录获取 uid
payload = {
    "jsonrpc": "2.0",
    "method": "call",
    "params": {"service": "common", "method": "login", "args": [db, username, password]},
    "id": 1
}
uid = requests.post(url, json=payload).json()['result']

# 批量创建
customers = [
    {'name': 'Alice', 'email': 'alice@example.com'},
    {'name': 'Bob', 'email': 'bob@example.com'},
]

payload = {
    "jsonrpc": "2.0",
    "method": "call",
    "params": {
        "service": "object",
        "method": "execute_kw",
        "args": [db, uid, password, 'res.partner', 'create', customers]
    },
    "id": 2
}
response = requests.post(url, json=payload).json()

```

---

### 2.3 自定义 RESTful API 批量导入

```
from odoo import http
from odoo.http import request

class CustomerController(http.Controller):

    @http.route('/api/customers/batch', type='json', auth='user', methods=['POST'], csrf=False)
    def create_customers(self):
        data = request.jsonrequest  # [{"name":"Alice"}, {"name":"Bob"}]
        created_ids = []
        for item in data:
            partner = request.env['res.partner'].sudo().create(item)
            created_ids.append(partner.id)
        return {"status": "success", "ids": created_ids}

```

- 接口接受 **JSON 数组**，批量创建客户
    
- 返回创建的 ID 列表
    

---

## 3. 批量导出数据

### 3.1 XML-RPC / JSON-RPC 示例

```
# 搜索并读取多个字段
partner_ids = models.execute_kw(db, uid, password,
    'res.partner', 'search', [[['is_company', '=', True]]])

partners_data = models.execute_kw(db, uid, password,
    'res.partner', 'read',
    [partner_ids], {'fields': ['name', 'email', 'phone']})

```

- `search` 返回符合条件的 ID 列表
    
- `read` 批量读取字段，返回字典列表
    

### 3.2 自定义 RESTful API 导出

```
@http.route('/api/customers/export', type='json', auth='user', methods=['GET'])
def export_customers(self):
    partners = request.env['res.partner'].sudo().search([])
    data = []
    for p in partners:
        data.append({
            "name": p.name,
            "email": p.email,
            "phone": p.phone,
        })
    return {"status": "success", "data": data}

```

- 返回 JSON 数组，供第三方系统导入
    
- 可配合分页、过滤条件优化性能
    

---

## 4. 批量操作性能优化

1. **使用 ORM 批量方法**
    
    - `create([{}, {}])` 一次插入多条记录
        
    - `write([{}])` 批量更新记录集
        
    - `search_read()` 一次搜索并读取字段
        
2. **避免循环内重复查询**
    
3. **分页导出大数据**
    
    `partners = env['res.partner'].search([], limit=100, offset=0)`
    
4. **使用 `sudo()` 或专用 API 用户权限**
    

---

## 5. 实际应用场景

|场景|方法|说明|
|---|---|---|
|导入客户|XML-RPC / JSON-RPC / REST API|批量创建或更新客户|
|导入订单|REST API|接收第三方系统 JSON 数据|
|导出销售数据|XML-RPC / JSON-RPC / REST API|批量读取并传给报表系统|
|移动端同步|REST API|批量拉取客户、订单、库存|
|数据迁移|XML-RPC + Python 脚本|批量迁移旧系统数据|

---

## 6. 注意事项

- **安全性**：
    
    - 批量接口建议使用 Token / OAuth2 或专用 API 用户
        
    - 避免暴露敏感模型
        
- **性能**：
    
    - 避免一次性操作过大数据，分页处理
        
- **数据校验**：
    
    - 必须验证输入字段和格式
        
    - 使用事务（ORM 自动支持）避免部分导入失败
        

---

## 7. 总结

- **批量导入/导出核心步骤**：
    
    1. 登录认证（XML-RPC / JSON-RPC / REST API）
        
    2. 批量创建 / 更新 / 查询记录
        
    3. 返回结果或 JSON 数据
        
- **接口选择**：
    
    - XML-RPC / JSON-RPC：传统脚本或跨语言系统
        
    - RESTful API：现代 Web / 移动端系统
        
- **性能优化**：
    
    - 使用 ORM 批量方法
        
    - 分页导出大数据
        
    - 使用事务和 sudo 控制权限
在 Odoo 中进行复杂的多级关系查询（`Domain`）和字段计算是其 ORM（对象关系映射）框架的强大之处。这允许你处理复杂的业务逻辑，而无需直接编写 SQL 查询。

### 复杂多级关系查询（`Domain`）

`Domain` 是 Odoo 中用于筛选记录的强大工具。它是一个由三元组 `(field_name, operator, value)` 组成的列表，通过逻辑运算符 `&` (AND), `|` (OR), `!` (NOT) 连接。对于多级关系查询，关键在于使用**点符号（`.`）**来访问关联模型上的字段。

#### 基本语法

- **`('field_name', 'operator', 'value')`**
    

**运算符**：`=, !=, >, <, >=, <=, in, not in, like, ilike, not like, not ilike, child_of, parent_of, =like, =ilike`。

#### 一级关联查询

假设你有一个 `Sale Order` 模型，它通过 `partner_id` 字段关联到 `res.partner` 模型。如果你想查找所有与“`客户 A`”相关的销售订单，`domain` 如下：

Python

```
domain = [('partner_id.name', '=', '客户 A')]
```

- `partner_id.name`：这里的 `partner_id` 是 `Sale Order` 上的字段，它指向 `res.partner` 模型。`.name` 则是访问 `res.partner` 上的 `name` 字段。
    

#### 多级关联查询

如果关系更复杂，比如你想找到所有**客户所在的国家**是“`中国`”的销售订单。`res.partner` 模型通过 `country_id` 字段关联到 `res.country` 模型。

Python

```
domain = [('partner_id.country_id.name', '=', '中国')]
```

- `partner_id.country_id.name`： Odoo 允许你通过这种方式一直深入下去，只要关联字段存在。
    

#### 示例：结合逻辑运算符

查找所有**客户**在“`中国`”，且**订单总价**超过 1000 的销售订单：

Python

```
domain = [
    ('partner_id.country_id.name', '=', '中国'),
    ('amount_total', '>', 1000)
]
```

- 两个三元组放在一个列表中，默认是 **AND** 关系。
    

查找所有**产品名称**中包含“`电脑`”，**或者****订单状态**是“`草稿`”的销售订单：

Python

```
domain = [
    '|',
    ('order_line.product_id.name', 'ilike', '电脑'),
    ('state', '=', 'draft')
]
```

- `|` 是 OR 运算符，它作用于其后的两个三元组。
    

### 字段计算

在 Odoo 中，计算字段（`Computed Fields`）是根据其他字段的值动态计算出来的字段，它不直接存储在数据库中，除非你显式指定 `store=True`。

#### 基本语法

Python

```
from odoo import models, fields, api

class SaleOrder(models.Model):
    _inherit = 'sale.order'

    # 定义一个计算字段
    my_computed_field = fields.Float(string='My Computed Field', compute='_compute_my_field')

    # 定义计算方法
    @api.depends('field1', 'related_field.sub_field')
    def _compute_my_field(self):
        for record in self:
            # 在这里编写计算逻辑
            # record.field1 + record.related_field.sub_field
            record.my_computed_field = ...
```

#### 关键元素

- `@api.depends(...)`：这是一个装饰器，用于声明计算字段所依赖的字段。**这是 Odoo 知道何时重新计算该字段的关键**。当依赖字段的值发生变化时，Odoo 就会自动调用计算方法。
    
- `self`：在计算方法中，`self` 是一个记录集（RecordSet）。你需要通过遍历 `for record in self` 来对每条记录进行操作，这是 Odoo ORM 的标准实践。
    

#### 示例：多级关联字段的计算

假设你想在销售订单上添加一个字段，用于显示客户的**国家名称**。

Python

```
from odoo import models, fields, api

class SaleOrder(models.Model):
    _inherit = 'sale.order'

    # 定义一个计算字段，用于显示客户所在的国家名称
    partner_country_name = fields.Char(string='Customer Country', compute='_compute_partner_country_name')

    # 依赖于 partner_id 和 partner_id.country_id 的变化
    @api.depends('partner_id', 'partner_id.country_id')
    def _compute_partner_country_name(self):
        for record in self:
            if record.partner_id and record.partner_id.country_id:
                record.partner_country_name = record.partner_id.country_id.name
            else:
                record.partner_country_name = False
```

- `@api.depends` 中同样使用点符号 `partner_id.country_id` 来追踪依赖。
    

#### 示例：反向关联字段的计算

假设你想在 `Product` 模型上添加一个字段，用于显示**有多少个销售订单**包含了该产品。

Python

```
from odoo import models, fields, api

class ProductTemplate(models.Model):
    _inherit = 'product.template'

    # 计算字段，用于显示包含该产品的销售订单数量
    sale_order_count = fields.Integer(
        string='Sale Order Count',
        compute='_compute_sale_order_count'
    )

    @api.depends('sale_order_line_ids') # 这里需要依赖于反向关联字段
    def _compute_sale_order_count(self):
        # sale_order_line_ids 是一个反向关联字段，指向所有包含该产品的销售订单行
        for record in self:
            record.sale_order_count = len(record.sale_order_line_ids.mapped('order_id'))
```

- `sale_order_line_ids` 是 Odoo 自动创建的反向关联字段。它代表了所有指向当前 `product.template` 记录的 `sale.order.line` 记录。
    
- `mapped('order_id')` 用于从 `sale.order.line` 记录集中提取所有关联的 `order_id`，从而得到包含该产品的销售订单记录集。
    

### 总结

- **`Domain` 查询**：使用**点符号（`.`）**来构建多级关联查询，并结合 `&`、`|`、`!` 等逻辑运算符实现复杂的过滤。
    
- **字段计算**：使用 `@api.depends` 装饰器，同样通过**点符号（`.`）**来声明对关联字段的依赖，从而实现多级关系的字段计算。
    

这两种机制是 Odoo 灵活且强大的数据处理能力的基石，掌握它们能让你更高效地进行 Odoo 开发。
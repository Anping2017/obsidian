# ğŸ¢ å¤šå…¬å¸ç¯å¢ƒæƒé™ç®¡ç†ï¼ˆOdoo 17ï¼‰

## 1) `company_id` å­—æ®µä¸å…¬å¸éš”ç¦»

**åŸåˆ™ï¼šä¸šåŠ¡æ¨¡å‹å¿…é¡»å¸¦ `company_id`ï¼Œç”¨è®°å½•è§„åˆ™åšç¡¬éš”ç¦»ã€‚**

- åœ¨è‡ªå®šä¹‰æ¨¡å‹ä¸ŠåŠ å­—æ®µï¼ˆå¹¶å»ºç´¢å¼• + é»˜è®¤å€¼ï¼‰ï¼š
    
```
from odoo import models, fields

class MyDoc(models.Model):
    _name = 'my.doc'
    _description = 'My Document'

    name = fields.Char(required=True)
    company_id = fields.Many2one(
        'res.company', required=True, index=True,
        default=lambda self: self.env.company
    )

```
    
- **å…¨å±€éš”ç¦»è§„åˆ™ï¼ˆæ‰€æœ‰äººéƒ½å—é™ï¼‰**ï¼š
    
    - å…è®¸â€œæ— å…¬å¸è®°å½•â€ä¸ºå…¨å±€ä¸»æ•°æ®ï¼ˆ`company_id = False` å¯å…±äº«ï¼‰ï¼š
        
```
<record id="rule_global_company_isolation" model="ir.rule">
  <field name="name">Global Company Isolation</field>
  <field name="model_id" ref="model_my_doc"/>
  <field name="domain_force">
    ['|', ('company_id','=', False), ('company_id','in', company_ids)]
  </field>
  <field name="perm_read" eval="True"/>
  <field name="perm_write" eval="True"/>
  <field name="perm_create" eval="True"/>
  <field name="perm_unlink" eval="True"/>
</record>

```
        
- **ä¸ºä»€ä¹ˆè¦å…è®¸ `False`**ï¼šäº§å“ã€UoMã€åˆ†ç±»ã€éƒ¨åˆ†ä¸»æ•°æ®å¯â€œé›†å›¢å…±äº«â€ã€‚ä¸å…±äº«åˆ™å»æ‰ `('company_id','=', False)`ã€‚
    

> å°è´´å£«ï¼šå‡¡â€œä¸šåŠ¡å•æ®â€å‡ ä¹éƒ½åº”è®¾ç½® `company_id`ï¼›è‹¥ä½ çš„è‡ªå®šä¹‰è¡¨ç¼ºå°‘å®ƒï¼ŒOdoo æ— æ³•åœ¨å¤šå…¬å¸ä¸‹å®‰å…¨éš”ç¦»ã€‚

---

## 2) `allowed_company_ids` ä¸åˆ‡æ¢å…¬å¸

**æ¦‚å¿µ**

- ç”¨æˆ·æœ‰ï¼š
    
    - `company_id`ï¼šå½“å‰å…¬å¸ï¼ˆç•Œé¢å³ä¸Šè§’åˆ‡æ¢ï¼‰
        
    - `company_ids`ï¼ˆ= `allowed_company_ids`ï¼‰ï¼šå…è®¸è®¿é—®çš„å…¬å¸é›†åˆ
        
- **è®°å½•è§„åˆ™é‡Œçš„ `company_ids`** å˜é‡ï¼ŒæŒ‡å‘ç”¨æˆ·çš„å…è®¸å…¬å¸é›†åˆã€‚
    

**åœ¨ UI/ä»£ç é‡Œåˆ‡æ¢**

- UIï¼šå³ä¸Šè§’å…¬å¸åˆ‡æ¢å™¨å³å¯åˆ‡æ¢ `env.company`ã€‚
    
- ä»£ç ï¼ˆä¸´æ—¶åœ¨æŸå…¬å¸ä¸‹æ‰§è¡Œä¸šåŠ¡ï¼‰ï¼š
    
    `target_co = self.env['res.company'].browse(target_company_id) self.env['my.doc'].with_company(target_co).search([...])`
    
- ä»£ç ï¼ˆä¸´æ—¶é™åˆ¶å¯è®¿é—®å…¬å¸é›†åˆï¼‰ï¼š
    
    `docs = self.env['my.doc'].with_context(allowed_company_ids=[1, 3]).search([])`
    

> åªåœ¨**ç¼©å°èŒƒå›´**æ—¶ä½¿ç”¨ `allowed_company_ids`ï¼ˆä¾‹å¦‚æŠ¥è¡¨é™å®šï¼‰ï¼Œ**ä¸è¦**éšæ„â€œæ”¾å¤§â€ã€‚æ‰©å¤§è®¿é—®èŒƒå›´åº”è¯¥é€šè¿‡**ç»™ç”¨æˆ·æˆæƒ**æŠŠå…¬å¸åŠ è¿› `company_ids`ï¼Œè€Œä¸æ˜¯é  context ç»•è¿‡ã€‚

---

## 3) è·¨å…¬å¸è®¿é—®æ§åˆ¶è®¾è®¡ï¼ˆå‡ ç§å¸¸è§æ–¹æ¡ˆï¼‰

### 3.1 å¼ºéš”ç¦» + é€‰æ‹©æ€§å…±äº«ï¼ˆæ¨èé»˜è®¤ï¼‰

- **å¼ºéš”ç¦»**ï¼šç”¨ä¸Šé¢çš„**å…¨å±€è§„åˆ™**åšç¡¬è¾¹ç•Œã€‚
    
- **å…±äº«ä¸»æ•°æ®**ï¼šæŠŠå¯å…±äº«çš„è®°å½•è®¾ `company_id = False`ï¼ˆæ¯”å¦‚äº§å“ã€UoMï¼‰ï¼Œå…¨ä½“å¯è¯»ï¼›å•æ®ä»æŒ‰å…¬å¸éš”ç¦»ã€‚
    

### 3.2 å—æ§å…±äº«ï¼ˆåªç»™éƒ¨åˆ†å…¬å¸äº’é€šï¼‰

- åœ¨è®°å½•ä¸Šå¢åŠ â€œå¯å…±äº«å…¬å¸â€å¤šå¯¹å¤šå­—æ®µï¼š
    
    `shared_company_ids = fields.Many2many('res.company', string='Shared With Companies')`
    
- è®°å½•è§„åˆ™ï¼ˆåˆ†ç»„è§„åˆ™ï¼Œæˆäºˆå…·å¤‡è·¨å…¬å¸æŸ¥çœ‹æƒé™çš„è§’è‰²ï¼‰ï¼š
    
```
<record id="rule_cross_company_read" model="ir.rule">
  <field name="name">Cross-company Read</field>
  <field name="model_id" ref="model_my_doc"/>
  <field name="groups" eval="[(6,0,[ref('your_module.group_cross_reader')])]"/>
  <field name="perm_read" eval="True"/>
  <field name="domain_force">
    ['|', ('company_id','in', company_ids),
          ('shared_company_ids','in', company_ids)]
  </field>
</record>

```
    
- å†™/åˆ æƒé™ä»å»ºè®®å— ACL æ§åˆ¶ï¼Œä»…å…è®¸åœ¨**å½“å‰å…¬å¸**å†™ï¼š
    
```
<record id="rule_write_same_company_only" model="ir.rule">
  <field name="name">Write Only in Current Company</field>
  <field name="model_id" ref="model_my_doc"/>
  <field name="perm_write" eval="True"/>
  <field name="domain_force">[('company_id','=', user.company_id.id)]</field>
</record>

```
    

### 3.3 ç®¡ç†å±‚â€œè·¨å…¬å¸åªè¯» + æœ¬å…¬å¸å¯å†™â€

- ç»™ç»ç†ç»„**OR**å‡ºæ›´å®½çš„åªè¯»åŸŸï¼ˆä½†ä»è¢«å…¨å±€éš”ç¦»â€œå¡ä½â€å…¶ä»–å…¬å¸æ•æ„Ÿå•æ®ï¼‰ï¼š
    
```
<record id="rule_mgr_read_all_allowed" model="ir.rule">
  <field name="name">Manager Read Across Allowed Companies</field>
  <field name="model_id" ref="model_my_doc"/>
  <field name="groups" eval="[(6,0,[ref('your_module.group_my_manager')])]"/>
  <field name="perm_read" eval="True"/>
  <field name="domain_force">[('company_id','in', company_ids)]</field>
</record>

```
    
- å†™åˆ ä»ç”¨ä¸Šä¸€æ¡â€œæœ¬å…¬å¸å¯å†™â€çš„è§„åˆ™æˆ–ç›´æ¥ç”¨ ACLâ€œç»ç†å¯å†™åˆ ï¼Œå‘˜å·¥ä¸å¯åˆ â€ã€‚
    

### 3.4 ä¾èµ–ä¸Šæ¸¸å¯¹è±¡çš„å…¬å¸ï¼ˆé“¾å¼éš”ç¦»ï¼‰

- æŸäº›è¡¨æ²¡æœ‰ `company_id`ï¼Œä½†èƒ½é€šè¿‡å…³è”å­—æ®µç¡®å®šå½’å±ï¼š
    
    `<!-- ä¾‹å¦‚æŒ‰è®¢å•çš„å…¬å¸éš”ç¦»è¡Œé¡¹ç›® --> <field name="domain_force">[('order_id.company_id','in', company_ids)]</field>`
    
- è‡ªå®šä¹‰è¡¨è‹¥ç¼º `company_id`ï¼Œå»ºè®®**æ–°å¢**æˆ–**åŠ  related** å­—æ®µï¼Œé¿å…é“¾è¿‡é•¿å½±å“æ€§èƒ½/å¯è¯»æ€§ã€‚
    

### 3.5 äº’å…¬å¸æµç¨‹ï¼ˆIntercompanyï¼‰

- è‹¥å¼€å¯äº’å…¬å¸è‡ªåŠ¨å•æ®ï¼ˆå¦‚è·¨å…¬å¸é”€å”®â†’é‡‡è´­ï¼‰ï¼ŒåŠ¡å¿…ï¼š
    
    1. ä¸¤è¾¹ç”¨æˆ·éƒ½è¢«æˆæƒåˆ°å„è‡ªå…¬å¸ï¼›
        
    2. ä¸»æ•°æ®ï¼ˆäº§å“ã€åˆä½œä¼™ä¼´ã€ç¨ã€ç§‘ç›®ç­‰ï¼‰æŒ‰**å…¬å¸ç‹¬ç«‹**æˆ–**å…¬å¸å…±äº«**æ–¹æ¡ˆäº‹å…ˆç»Ÿä¸€ï¼›
        
    3. ç”¨**åªè¯»è·¨å…¬å¸è§„åˆ™**ä¿è¯å¯æŸ¥çœ‹å¯¹æ–¹å•æ®ï¼Œä½†**å†™å…¥ä»…é™æœ¬å…¬å¸**ã€‚
        

---

## ğŸ§ª è‡ªæ£€æ¸…å•ï¼ˆä¸Šçº¿å‰åŠ¡å¿…è¿‡ä¸€éï¼‰

1. ä¸šåŠ¡æ¨¡å‹æ˜¯å¦éƒ½æœ‰ `company_id`ï¼ˆæˆ–å¯æ˜ç¡®è¿½æº¯åˆ°å…¬å¸ï¼‰ï¼Ÿ
    
2. **å…¨å±€éš”ç¦»è§„åˆ™**æ˜¯å¦å·²é…ç½®å¹¶ç”Ÿæ•ˆï¼Ÿ
    
3. å…±äº«ä¸»æ•°æ®æ˜¯å¦é‡‡ç”¨ `company_id=False`ï¼ˆæˆ–å—æ§å…±äº«å­—æ®µï¼‰ï¼Ÿ
    
4. ç®¡ç†å±‚æ˜¯å¦éœ€è¦**è·¨å…¬å¸åªè¯»**ï¼Œå¹¶æ˜ç¡®**å†™åˆ **è¾¹ç•Œï¼Ÿ
    
5. æŠ¥è¡¨/å‘å¯¼æ˜¯å¦ç”¨ `with_company/with_context` **ç¼©å°**å…¬å¸èŒƒå›´è€Œéæ‰©å¤§ï¼Ÿ
    
6. ACL ä¸è®°å½•è§„åˆ™æ˜¯å¦é…å¥—ï¼ˆACL æ§ CRUDï¼Œè§„åˆ™æ§â€œå“ªäº›è®°å½•â€ï¼‰ï¼Ÿ
    
7. åºåˆ—ã€ç¨ã€æ—¥è®°è´¦ã€ç§‘ç›®ã€ä»“åº“/åœ°ç‚¹ç­‰**å…¬å¸ä¸“å±é…ç½®**æ˜¯å¦å„å…¬å¸éƒ½å·²è®¾ç½®å¦¥å½“ï¼Ÿ
    

---

## ğŸ§¯ å¸¸è§å‘

- **åœ¨é”™è¯¯çš„å½“å‰å…¬å¸åˆ›å»ºå•æ®** â†’ é€ æˆä¼šè®¡/åº“å­˜å…¥é”™è´¦ï¼›ç»™å…³é”®ç”¨æˆ·åŠ é†’ç›®çš„â€œå½“å‰å…¬å¸â€å­—æ®µæˆ–ç™»é™†è½åœ°åŠ¨ä½œé™åˆ¶ã€‚
    
- **ç¼ºå°‘å…¨å±€è§„åˆ™** â†’ å…è®¸è·¨å…¬å¸è¯¯è¯»æ•°æ®ã€‚
    
- **æ»¥ç”¨ `allowed_company_ids` æ‰©æƒ** â†’ è¯·é€šè¿‡ç”¨æˆ·æˆæƒå¢åŠ å…¬å¸ï¼Œä¸è¦ç”¨ context æ”¾å¤§èŒƒå›´ã€‚
    
- **å…±äº«äº§å“ä½†æœªä¸ºå„å…¬å¸é…ç½®ä¼šè®¡å±æ€§**ï¼ˆ`ir.property` æŒ‰å…¬å¸å­˜å‚¨ï¼‰â†’ è¿‡è´¦æŠ¥é”™ã€‚
    
- **æŠŠ UI çš„ `domain/attrs` å½“å®‰å…¨æ‰‹æ®µ** â†’ è®°å¾—å®‰å…¨å¿…é¡»è½åœ¨**æœåŠ¡ç«¯è§„åˆ™**ã€‚
    

---

## ğŸ“ å¿«é€Ÿæ¨¡æ¿æ±‡æ€»

**æ¨¡å‹å­—æ®µï¼š**

`company_id = fields.Many2one('res.company', required=True,                              default=lambda self: self.env.company, index=True)`

**å…¨å±€éš”ç¦»ï¼š**

`['|', ('company_id','=', False), ('company_id','in', company_ids)]`

**è·¨å…¬å¸åªè¯» + æœ¬å…¬å¸å¯å†™ï¼ˆç»ç†ç»„ï¼‰ï¼š**

```
# è¯»
[('company_id','in', company_ids)]
# å†™
[('company_id','=', user.company_id.id)]

```

**å—æ§å…±äº«ï¼ˆå¸¦ shared_company_idsï¼‰ï¼š**

`['|', ('company_id','in', company_ids),       ('shared_company_ids','in', company_ids)]`
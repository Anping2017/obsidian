# 🏢 多公司环境权限管理（Odoo 17）

## 1) `company_id` 字段与公司隔离

**原则：业务模型必须带 `company_id`，用记录规则做硬隔离。**

- 在自定义模型上加字段（并建索引 + 默认值）：
    
```
from odoo import models, fields

class MyDoc(models.Model):
    _name = 'my.doc'
    _description = 'My Document'

    name = fields.Char(required=True)
    company_id = fields.Many2one(
        'res.company', required=True, index=True,
        default=lambda self: self.env.company
    )

```
    
- **全局隔离规则（所有人都受限）**：
    
    - 允许“无公司记录”为全局主数据（`company_id = False` 可共享）：
        
```
<record id="rule_global_company_isolation" model="ir.rule">
  <field name="name">Global Company Isolation</field>
  <field name="model_id" ref="model_my_doc"/>
  <field name="domain_force">
    ['|', ('company_id','=', False), ('company_id','in', company_ids)]
  </field>
  <field name="perm_read" eval="True"/>
  <field name="perm_write" eval="True"/>
  <field name="perm_create" eval="True"/>
  <field name="perm_unlink" eval="True"/>
</record>

```
        
- **为什么要允许 `False`**：产品、UoM、分类、部分主数据可“集团共享”。不共享则去掉 `('company_id','=', False)`。
    

> 小贴士：凡“业务单据”几乎都应设置 `company_id`；若你的自定义表缺少它，Odoo 无法在多公司下安全隔离。

---

## 2) `allowed_company_ids` 与切换公司

**概念**

- 用户有：
    
    - `company_id`：当前公司（界面右上角切换）
        
    - `company_ids`（= `allowed_company_ids`）：允许访问的公司集合
        
- **记录规则里的 `company_ids`** 变量，指向用户的允许公司集合。
    

**在 UI/代码里切换**

- UI：右上角公司切换器即可切换 `env.company`。
    
- 代码（临时在某公司下执行业务）：
    
    `target_co = self.env['res.company'].browse(target_company_id) self.env['my.doc'].with_company(target_co).search([...])`
    
- 代码（临时限制可访问公司集合）：
    
    `docs = self.env['my.doc'].with_context(allowed_company_ids=[1, 3]).search([])`
    

> 只在**缩小范围**时使用 `allowed_company_ids`（例如报表限定），**不要**随意“放大”。扩大访问范围应该通过**给用户授权**把公司加进 `company_ids`，而不是靠 context 绕过。

---

## 3) 跨公司访问控制设计（几种常见方案）

### 3.1 强隔离 + 选择性共享（推荐默认）

- **强隔离**：用上面的**全局规则**做硬边界。
    
- **共享主数据**：把可共享的记录设 `company_id = False`（比如产品、UoM），全体可读；单据仍按公司隔离。
    

### 3.2 受控共享（只给部分公司互通）

- 在记录上增加“可共享公司”多对多字段：
    
    `shared_company_ids = fields.Many2many('res.company', string='Shared With Companies')`
    
- 记录规则（分组规则，授予具备跨公司查看权限的角色）：
    
```
<record id="rule_cross_company_read" model="ir.rule">
  <field name="name">Cross-company Read</field>
  <field name="model_id" ref="model_my_doc"/>
  <field name="groups" eval="[(6,0,[ref('your_module.group_cross_reader')])]"/>
  <field name="perm_read" eval="True"/>
  <field name="domain_force">
    ['|', ('company_id','in', company_ids),
          ('shared_company_ids','in', company_ids)]
  </field>
</record>

```
    
- 写/删权限仍建议受 ACL 控制，仅允许在**当前公司**写：
    
```
<record id="rule_write_same_company_only" model="ir.rule">
  <field name="name">Write Only in Current Company</field>
  <field name="model_id" ref="model_my_doc"/>
  <field name="perm_write" eval="True"/>
  <field name="domain_force">[('company_id','=', user.company_id.id)]</field>
</record>

```
    

### 3.3 管理层“跨公司只读 + 本公司可写”

- 给经理组**OR**出更宽的只读域（但仍被全局隔离“卡住”其他公司敏感单据）：
    
```
<record id="rule_mgr_read_all_allowed" model="ir.rule">
  <field name="name">Manager Read Across Allowed Companies</field>
  <field name="model_id" ref="model_my_doc"/>
  <field name="groups" eval="[(6,0,[ref('your_module.group_my_manager')])]"/>
  <field name="perm_read" eval="True"/>
  <field name="domain_force">[('company_id','in', company_ids)]</field>
</record>

```
    
- 写删仍用上一条“本公司可写”的规则或直接用 ACL“经理可写删，员工不可删”。
    

### 3.4 依赖上游对象的公司（链式隔离）

- 某些表没有 `company_id`，但能通过关联字段确定归属：
    
    `<!-- 例如按订单的公司隔离行项目 --> <field name="domain_force">[('order_id.company_id','in', company_ids)]</field>`
    
- 自定义表若缺 `company_id`，建议**新增**或**加 related** 字段，避免链过长影响性能/可读性。
    

### 3.5 互公司流程（Intercompany）

- 若开启互公司自动单据（如跨公司销售→采购），务必：
    
    1. 两边用户都被授权到各自公司；
        
    2. 主数据（产品、合作伙伴、税、科目等）按**公司独立**或**公司共享**方案事先统一；
        
    3. 用**只读跨公司规则**保证可查看对方单据，但**写入仅限本公司**。
        

---

## 🧪 自检清单（上线前务必过一遍）

1. 业务模型是否都有 `company_id`（或可明确追溯到公司）？
    
2. **全局隔离规则**是否已配置并生效？
    
3. 共享主数据是否采用 `company_id=False`（或受控共享字段）？
    
4. 管理层是否需要**跨公司只读**，并明确**写删**边界？
    
5. 报表/向导是否用 `with_company/with_context` **缩小**公司范围而非扩大？
    
6. ACL 与记录规则是否配套（ACL 控 CRUD，规则控“哪些记录”）？
    
7. 序列、税、日记账、科目、仓库/地点等**公司专属配置**是否各公司都已设置妥当？
    

---

## 🧯 常见坑

- **在错误的当前公司创建单据** → 造成会计/库存入错账；给关键用户加醒目的“当前公司”字段或登陆落地动作限制。
    
- **缺少全局规则** → 允许跨公司误读数据。
    
- **滥用 `allowed_company_ids` 扩权** → 请通过用户授权增加公司，不要用 context 放大范围。
    
- **共享产品但未为各公司配置会计属性**（`ir.property` 按公司存储）→ 过账报错。
    
- **把 UI 的 `domain/attrs` 当安全手段** → 记得安全必须落在**服务端规则**。
    

---

## 📎 快速模板汇总

**模型字段：**

`company_id = fields.Many2one('res.company', required=True,                              default=lambda self: self.env.company, index=True)`

**全局隔离：**

`['|', ('company_id','=', False), ('company_id','in', company_ids)]`

**跨公司只读 + 本公司可写（经理组）：**

```
# 读
[('company_id','in', company_ids)]
# 写
[('company_id','=', user.company_id.id)]

```

**受控共享（带 shared_company_ids）：**

`['|', ('company_id','in', company_ids),       ('shared_company_ids','in', company_ids)]`
（Record Rules）

## 1) 机制与概念（搞清“谁先谁后”）

- **触发顺序**：先检查 **ACL**（模型的读/写/建/删权限），通过后才会应用**记录规则**做“数据行级过滤”。[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)
    
- **无规则=允许**：若 ACL 允许、且该模型/操作没有任何适用的记录规则，则默认允许访问。[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)
    
- **两类规则如何组合**：
    
    - **全局规则（无分组）**：相互 **相交（AND）**，叠加越多越严格；
        
    - **分组规则（绑定到某些 groups）**：彼此 **并集（OR）**，能放宽访问，但**不会突破全局规则**的边界；
        
    - **全局 ∩ 分组**：先用全局收紧，再由分组在这个边界内放宽。[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)
        

> ⚠️ 含义：第一个分组规则通常会“变严”（因为与全局相交），之后追加的分组规则才可能“放宽”。[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)

## 🔑 记录规则的组合逻辑

### a. 全局规则（Global Rule）

- 定义时 **不绑定任何组（groups 为空）**。
    
- 适用于系统中所有用户（包括超级用户除外）。
    
- **组合方式**：多个全局规则之间是 **相交（AND）**。
    
    - 每条全局规则都会生效，过滤条件越来越严格。
        

👉 举例：

- 全局规则 A：只能看自己创建的记录 → `[('create_uid', '=', user.id)]`
    
- 全局规则 B：只能看属于当前公司数据 → `[('company_id', 'in', company_ids)]`
    
- 最终结果 = A ∩ B → 用户只能看“自己创建 + 属于自己公司”的记录。
    

---

### b. 分组规则（Group Rule）

- 定义时 **绑定到一个或多个用户组**。
    
- 只有该组内的用户才受规则限制。
    
- **组合方式**：同一模型下的多条分组规则是 **并集（OR）**。
    
    - 满足其中任意一个 domain 条件，就能看到记录。
        

👉 举例：

- 分组规则 A：销售员 → `[('user_id', '=', user.id)]`（只能看自己单）
    
- 分组规则 B：销售经理 → `[(1, '=', 1)]`（能看全部）
    
- 同时在“销售经理组”的用户，最终能看 = 自己单 ∪ 全部 = 全部数据。
    

---

### c. 全局 ∩ 分组

- 最终结果：**全局规则先收紧，分组规则在这个边界里放宽**。
    
- 换句话说：分组规则 **不能突破全局规则的限制**。
    

👉 举例：

- 全局规则：所有销售订单必须属于当前公司 → `[('company_id', 'in', company_ids)]`
    
- 分组规则：
    
    - 销售员：`[('user_id', '=', user.id)]`
        
    - 销售经理：`[(1, '=', 1)]`（所有订单）
        
- 最终结果：
    
    - 销售员 → “自己 + 当前公司”订单。
        
    - 销售经理 → “所有订单 + 当前公司”订单（不能看到别的公司订单）。


---

## 2) 定义位置与关键字段（ir.rule）

- **模型**：`ir.rule`
    
- 关键字段：
    
    - `model_id`（作用对象）
        
    - `groups`（不填=全局规则）
        
    - `domain_force`（核心：域表达式）
        
    - `perm_read/perm_write/perm_create/perm_unlink`（该规则作用到哪些操作）
        
- **域中可用变量**：`user`、`company_id`、`company_ids`、`time` 等。[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)
    

---

## 3) 域（domain）写法要点

- 典型 **True** 域：`[(1, '=', 1)]`（等价“不过滤”）。
    
- 典型 **False** 域：`[(1, '=', 0)]`（等价“全部拒绝”——慎用，通常作为**全局**规则时会直接封死）。
    
- **company 共享**常用写法：`['|', ('company_id', '=', False), ('company_id', 'in', company_ids)]`（允许“无公司记录”+“在可访问公司内的记录”）。[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)
    

---

## 4) 常见场景与可复制示例

### A. 只看自己创建/负责的记录

**思路**：绑定到“员工/业务员组”的**分组规则**，按负责人或创建者过滤。

```
<record id="rule_so_salesman_own" model="ir.rule">
  <field name="name">Sales Orders - Own Only</field>
  <field name="model_id" ref="sale.model_sale_order"/>
  <field name="groups" eval="[(6,0,[ref('sales_team.group_sale_salesman')])]"/>
  <!-- 选你用的字段：user_id / create_uid -->
  <field name="domain_force">[('user_id','=', user.id)]</field>
  <field name="perm_read" eval="True"/>
  <field name="perm_write" eval="True"/>
  <field name="perm_create" eval="True"/>
  <field name="perm_unlink" eval="False"/>
</record>
```


> 注：也可用 `('create_uid','=', user.id)`；推荐优先用业务“负责人字段”（如 `user_id`）。[cybrosys.com+1](https://www.cybrosys.com/blog/how-to-create-record-rules-in-odoo-17?utm_source=chatgpt.com)

---

### B. 仅访问当前公司数据（多公司隔离）

**思路**：做**全局规则**（不绑组），所有人都受限；允许“无公司记录”。

```
<record id="rule_global_company_isolation" model="ir.rule">
  <field name="name">Global - Company Isolation</field>
  <field name="model_id" ref="sale.model_sale_order"/>
  <!-- 不设置 groups = 全局规则 -->
  <field name="domain_force">
    ['|', ('company_id','=', False), ('company_id','in', company_ids)]
  </field>
  <field name="perm_read" eval="True"/>
  <field name="perm_write" eval="True"/>
  <field name="perm_create" eval="True"/>
  <field name="perm_unlink" eval="True"/>
</record>

```

> 全局规则彼此 **AND**；与分组规则 **相交**。这是多公司隔离的标准写法。[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)

---

### C. 部门经理可看本部门（含下属）数据

**前提**：有 HR 组织结构（`hr.employee.department_id`），记录上能关联负责人或员工。

```
<record id="rule_mgr_department_scope" model="ir.rule">
  <field name="name">Manager - Department & Sub</field>
  <field name="model_id" ref="sale.model_sale_order"/>
  <field name="groups" eval="[(6,0,[ref('sales_team.group_sale_manager')])]"/>
  <field name="domain_force">
    ['|',
      ('user_id','=', user.id),
      ('user_id.employee_id.department_id', 'child_of', user.employee_id.department_id.id)
    ]
  </field>
  <field name="perm_read" eval="True"/>
  <field name="perm_write" eval="True"/>
</record>

```

> `child_of` 会包含子部门。若没装 HR，可改为你自建的“部门/团队”字段链路。[Stack Overflow](https://stackoverflow.com/questions/75087744/how-to-manage-implicit-groups-in-record-rules?utm_source=chatgpt.com)

---

### D. 只允许“草稿”可删除/编辑（条件操作权限）

**做法**：针对 **write/unlink** 勾选，仅当满足域才允许对应操作；不满足则等同于**无匹配规则→拒绝**。

```
<record id="rule_edit_draft_only" model="ir.rule">
  <field name="name">Edit/Unlink Draft Only</field>
  <field name="model_id" ref="sale.model_sale_order"/>
  <!-- 可设为全局或分组 -->
  <field name="domain_force">[('state','=','draft')]</field>
  <field name="perm_read" eval="False"/>
  <field name="perm_write" eval="True"/>
  <field name="perm_unlink" eval="True"/>
  <field name="perm_create" eval="False"/>
</record>

```

> 规则上的 `perm_*` 在记录规则里表示“规则适用于哪些操作”，不是授予动作本身。[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)

---

## 5) 调试与排错（最实用清单）

1. **开发者模式** → 设置 ▸ 技术 ▸ 安全性 ▸ 记录规则/访问权限，核对**谁生效**、**对哪些操作生效**。[Bassam Infotech+1](https://bassaminfotech.com/creating-a-record-rule-in-odoo/?utm_source=chatgpt.com)
    
2. **用户视角复现**：
    
    - Shell/代码里用 `with_user(u)` 对比 `sudo()` 的搜索结果：
        
```
env['sale.order'].with_user(u).search_count([])
env['sale.order'].sudo().search_count([])

```


`check_access_rights('read', raise_exception=False)` 与 `check_access_rule('read')` 辅助定位。



3. **逐步排除**：先停用可疑规则（取消勾选“启用/Active”），再观察结果变化。[useopenerp.com](https://useopenerp.com/v8/model/ir-rule?utm_source=chatgpt.com)
    
4. **组合关系心法**：
    
    - 全局规则 **AND**，易“互不相交→全被挡”；
        
    - 分组规则 **OR**，越加越放宽，但放不出全局围栏；
        
    - 先有 ACL，再谈记录规则。[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)
        
5. **多公司陷阱**：别忘了统一加 `('company_id','in', company_ids)`（或含 `False` 的并联），避免跨公司误见或误拒。[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)
    
6. **写/删被拦**：若读得到但写/删报错，检查：
    
    - ACL 是否给了 write/unlink；
        
    - 记录规则里 `perm_write/perm_unlink` 是否勾了，且域是否匹配当前记录。[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)
        

---

## 6) 安全与最佳实践

- **先 ACL 后规则**：能用 ACL 控住“能否写/删”，就先用 ACL；条件化再用规则细化（如仅 draft 可删）。[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)
    
- **全局规则越少越好**：集中处理“公司隔离/归档过滤”等共性，避免多个全局域互相“打架”。[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)
    
- **避免滥用 `sudo()`**：外部接口/按钮若用 `sudo()` 写数据，可能绕过记录规则；谨慎使用。[Odoo](https://www.odoo.com/documentation/19.0/developer/reference/backend/security.html)
    
- **互斥组设计**：层级组继承常会把“可见性规则”一并继承到经理组；必要时给经理组**单独覆盖**一条放宽规则。[Stack Overflow](https://stackoverflow.com/questions/75087744/how-to-manage-implicit-groups-in-record-rules?utm_source=chatgpt.com)